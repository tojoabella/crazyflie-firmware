# Kalman Estimator Inventory

## Directory guide
- `src/modules/interface/estimator/`: Public headers (`estimator.h`, `estimator_kalman.h`, etc.) that define the RTOS-agnostic API, measurement structs and enqueue helpers used by decks, drivers and the stabilizer loop.
- `src/modules/src/estimator/`: Front-end glue that implements the queue, estimator selection and RTOS tasks for each backend (`estimator.c`, `estimator_kalman.c`, `estimator_complementary.c`, ...).
- `src/modules/interface/kalman_core/`: EKF-facing headers that describe the core state vector, params and measurement model entry points.
- `src/modules/src/kalman_core/`: Implementation of the EKF math (predict/finalize/process noise) and per-sensor measurement models under `mm_*`.
- `src/modules/interface/outlierfilter/` & `src/modules/src/outlierfilter/`: Filtering helpers that gate measurements before they reach the EKF.
- `docs/kalman/`: High-level documentation (this file, pipeline/state/sensor descriptions).

The table below maps every source file that takes part in the Crazyflie Extended Kalman Filter (EKF) pipeline. Follow the "Path" links directly in the repository for deeper reading.

| Path | Category | Key functions / structs | Responsibility |
| --- | --- | --- | --- |
| `src/modules/interface/estimator/estimator.h` | Estimator interface | `measurement_t`, `stateEstimator*`, `estimatorEnqueue*` helpers | Defines the estimator selection API, measurement queue structure and helper functions that deck drivers use to feed sensor data into whichever estimator backend is active. |
| `src/modules/src/estimator/estimator.c` | Estimator selection glue | `stateEstimatorInit`, `stateEstimatorSwitchTo`, measurement queue helpers | Multiplexes between complementary, EKF and UKF estimators, exposes `estimatorEnqueue*` helpers that feed the Kalman queue, and handles runtime estimator switching. |
| `src/modules/interface/estimator/estimator_kalman.h` | Estimator interface | `estimatorKalmanInit`, `estimatorKalman`, `estimatorKalmanGetEstimatedPos/Rot` | Public API used by the stabilizer to start, run and query the Kalman estimator. |
| `src/modules/src/estimator/estimator_kalman.c` | Core estimator task | `estimatorKalmanTaskInit`, `kalmanTask`, `updateQueuedMeasurements`, log/param groups | FreeRTOS task that drives the predict/update loop, dequeues measurements, schedules process noise, exposes params/logs and copies the EKF state to the stabilizer. |
| `src/modules/interface/kalman_core/kalman_core.h` | Kalman core API | `kalmanCoreData_t`, `kalmanCoreParams_t`, `kalmanCorePredict`, `kalmanCoreScalarUpdate` | Defines the EKF state vector, covariance container and all predict/update helpers used by measurement model sources. |
| `src/modules/src/kalman_core/kalman_core.c` | Core filter implementation | `kalmanCoreInit`, `kalmanCorePredict`, `kalmanCoreAddProcessNoise`, `kalmanCoreFinalize`, `kalmanCoreExternalizeState` | Implements the predict step, process noise integration, Joseph-form scalar update, quaternion finalization and state externalization. |
| `src/modules/interface/kalman_core/kalman_core_params_defaults.h` | Configuration defaults | `KALMAN_CORE_DEFAULT_PARAMS_INIT` macro | Single source of truth for default process/measurement noise and initialization values used by estimator_kalman.c and Python bindings. |
| `src/modules/interface/kalman_supervisor.h` | Supervisor interface | `kalmanSupervisorIsStateWithinBounds` | Declares the supervisor hook consumed by estimator_kalman.c. |
| `src/modules/src/kalman_supervisor.c` | Supervisor | `kalmanSupervisorIsStateWithinBounds`, param group | Checks if the EKF state diverges outside configured bounds and triggers resets; exposes guard rails as parameters. |
| `src/modules/[src,interface]/kalman_core/mm_distance.[c,h]` | Sensor update (LPS TWR) | `kalmanCoreUpdateWithDistance` | Scalar update that projects one anchor distance measurement into the global XYZ states. |
| `src/modules/[src,interface]/kalman_core/mm_distance_robust.[c,h]` | Sensor update (robust TWR) | `kalmanCoreRobustUpdateWithDistance` | Iteratively reweighted distance update that mitigates UWB outliers by re-scaling P and K before calling `kalmanCoreUpdateWithPKE`. |
| `src/modules/[src,interface]/kalman_core/mm_tdoa.[c,h]`| Sensor update (LPS TDoA) | `kalmanCoreUpdateWithTdoa` | Computes the range-difference Jacobian, runs optional outlier filtering and feeds the scalar update with TDoA innovations. |
| `src/modules/src/kalman_core/mm_tdoa_robust.c` / `interface/kalman_core/mm_tdoa_robust.h` | Sensor update (robust TDoA) | `kalmanCoreRobustUpdateWithTdoa` | Implements G-M robust statistics for TDoA (P/K weighting, gating, optional TWR assistance) before delegating to `kalmanCoreUpdateWithPKE`. |
| `src/modules/[src,interface]/kalman_core/mm_position.[c,h]` | Sensor update (absolute XYZ) | `kalmanCoreUpdateWithPosition` | Straightforward absolute position measurement update (external positioning systems). |
| `src/modules/[src,interface]/kalman_core/mm_pose.[c,h]`| Sensor update (pose+quat) | `kalmanCoreUpdateWithPose` | Updates position and quaternion error states from external pose inputs (e.g., Lighthouse, MoCap). |
| `src/modules/[src,interface]/kalman_core/mm_flow.[c,h]`| Sensor update (optical flow) | `kalmanCoreUpdateWithFlow`, log group `kalman_pred` | Uses body velocities, altitude and gyro rates to predict pixel flow and performs two scalar updates (x/y) with gyro de-rotation. |
| `src/modules/[src,interface]/kalman_core/mm_tof.[c,h]` | Sensor update (time-of-flight range) | `kalmanCoreUpdateWithTof` | Projects one range-to-surface measurement (z-ranger) into the Z state with geometry-aware Jacobian. |
| `src/modules/[src,interface]/kalman_core/mm_absolute_height.[c,h]` | Sensor update (VL53/VL6180 height) | `kalmanCoreUpdateWithAbsoluteHeight` | Simple scalar update tying the world Z state to an absolute height sensor in the deck frame. |
| `src/modules/[src,interface]/kalman_core/mm_yaw_error.[c,h]` | Sensor update (yaw fusion) | `kalmanCoreUpdateWithYawError` | Uses external yaw references (e.g., Lighthouse sweep) by injecting yaw error directly into the attitude error state. |
| `src/modules/[src,interface]/kalman_core/mm_sweep_angles.[c,h]` | Sensor update (Lighthouse sweeps) | `kalmanCoreUpdateWithSweepAngles` | Processes lighthouse sweep pairs, runs lighthouse-specific outlier filter and updates yaw/position through geometric Jacobians. |
| `src/modules/[src,interface]/outlierfilter/outlierFilterTdoa.[c,h]` | Measurement gating | `outlierFilterTdoaValidateIntegrator`, `OutlierFilterTdoaState_t` | Adaptive integrator-based gate that opens/closes the TDoA measurement acceptance window depending on residual statistics. |
| `src/modules/[src,interface]/outlierfilter/outlierFilterTdoaSteps.[c,h]` | Measurement gating (legacy) | `outlierFilterTdoaValidateSteps` | Step/bucket-based fallback filter that gradually widens/narrows acceptable TDoA residuals when the integrator filter is unavailable. |
| `src/modules/src/outlierfilter/outlierFilterLighthouse.c` / `interface/outlierfilter/outlierFilterLighthouse.h` | Measurement gating (Lighthouse) | `outlierFilterLighthouseValidateSweep` | Maintains a dynamic acceptance window for lighthouse sweep angle residuals to prevent corrupt packets from disturbing the EKF. |
| `src/modules/src/stabilizer.c` | Stabilizer integration | `stabilizerInit`, `stabilizerTask`, `stateEstimatorGetType` | Owns the main control loop, selects the Kalman estimator through params, pulls EKF outputs each loop and forwards them to controllers/commanders. |
